This is a version of the code using Lwt. 